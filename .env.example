# =========================
# okx-quant-lab (.env)
# =========================
# 说明：
# - 默认跑「模拟盘 / Demo」(OKX_SIMULATED_TRADING=1)。
# - EXECUTION_MODE=DRYRUN 可在没有 APIKey 的情况下跑通整条链路（仅模拟下单/成交）。
# - EXECUTION_MODE=OKX 则会真实调用 OKX API（仍然是模拟盘环境，前提是你用的是 Demo APIKey，并且 x-simulated-trading=1）。

ENV=dev
LOG_LEVEL=INFO

# --- Infra ---
NATS_URL=nats://nats:4222
REDIS_URL=redis://redis:6379/0

# SQLAlchemy async URL (给 Python 用)
DATABASE_URL=postgresql+asyncpg://quant:quant@postgres:5432/quant
# 纯 Postgres URL（给 pg_dump 备份用）
DATABASE_URL_PG=postgresql://quant:quant@postgres:5432/quant

POSTGRES_USER=quant
POSTGRES_PASSWORD=quant
POSTGRES_DB=quant

# --- Trading universe ---
# 建议先从 2-3 个品种开始，避免数据/订单压力
INSTRUMENTS=BTC-USDT,ETH-USDT,BTC-USDT-SWAP,ETH-USDT-SWAP

# --- Strategy switches ---
ENABLED_STRATEGIES=grid,pairs,cash_carry

# ============ GRID ============
# 指定网格跑哪些品种（空=默认取 INSTRUMENTS 的第一个）
GRID_INSTRUMENTS=BTC-USDT

GRID_LEVELS=5
# 网格间距（bps = 0.01%）
GRID_SPREAD_BPS=30
# 每格下单金额（USDT 计价），会按价格换算成 sz
GRID_ORDER_USDT=20
# 价格偏离中心超过该阈值（bps）自动重心
GRID_REBALANCE_BPS=80

# ============ PAIRS ============
# 建议用永续合约（可做多空），默认用 SWAP
PAIRS_A=BTC-USDT-SWAP
PAIRS_B=ETH-USDT-SWAP
PAIRS_LOOKBACK=200
PAIRS_ENTRY_Z=2.0
PAIRS_EXIT_Z=0.3
PAIRS_LEG_USDT=30
PAIRS_TD_MODE=cross

# ============ CASH & CARRY ============
# 示例：现货 + 永续
CARRY_SPOT=BTC-USDT
CARRY_FUT=BTC-USDT-SWAP
CARRY_LEG_USDT=30
CARRY_MIN_BASIS_BPS=50
CARRY_EXIT_BASIS_BPS=10
CARRY_TD_MODE=cross

# --- Risk controls ---
# 全局熔断/急停：1=停，0=开
KILL_SWITCH=1

RISK_MAX_NOTIONAL_USDT=200
RISK_MAX_POSITION_USDT=1000
RISK_MAX_PRICE_DEVIATION_BPS=80
RISK_MAX_ORDERS_PER_MIN=60

# --- Risk+Capital (production-grade) ---
RISK_USE_REDIS_RATE_LIMIT=true
RISK_RATE_LIMIT_GLOBAL_PER_MIN=120
RISK_RATE_LIMIT_PER_STRATEGY_PER_MIN=90

# 如果暂时拿不到账户权益（例如 DRYRUN），使用该值作为风控基准
RISK_FALLBACK_EQUITY_USDT=1000

# 单笔订单上限（占权益比例）
RISK_MAX_ORDER_PCT_OF_EQUITY=0.05
# 总敞口上限（占权益比例）：pos_gross + open_orders_notional
RISK_MAX_GROSS_EXPOSURE_PCT_OF_EQUITY=2.0
# 净敞口上限（占权益比例）
RISK_MAX_NET_EXPOSURE_PCT_OF_EQUITY=1.0

# 回撤/日亏损熔断
RISK_ENABLE_DRAWDOWN_KILL=true
RISK_MAX_DRAWDOWN_PCT=0.2
RISK_ENABLE_DAILY_LOSS_KILL=true
RISK_MAX_DAILY_LOSS_USDT=200

# 预留资金（未成交挂单会占用一定额度）
RISK_USE_CAPITAL_RESERVATION=true
RISK_CASH_MARGIN_FACTOR=1.0
# 永续/杠杆的保证金估算系数（越大越保守）
RISK_DERIV_MARGIN_FACTOR=0.2

# --- OMS (execution) ---
OMS_WORKER_BATCH=10
OMS_MAX_ATTEMPTS=8
OMS_RETRY_BASE_MS=300
OMS_RETRY_MAX_MS=10000

# 可选：对 OKX 订单接口增加 expTime header（= now + OKX_EXP_TIME_MS），0=关闭
OKX_EXP_TIME_MS=0

# --- Portfolio polling (OKX mode) ---
PF_BALANCE_POLL_S=15
PF_POSITIONS_POLL_S=15


# --- Execution ---
# OKX = 真实调用 OKX API (建议 Demo)
# DRYRUN = 本地模拟撮合（无 APIKey 也可跑）
EXECUTION_MODE=DRYRUN

# 强制防呆：实盘必须显式允许
ALLOW_LIVE_TRADING=false

# 1=模拟盘，0=实盘
OKX_SIMULATED_TRADING=1

# ==============================
# OKX Endpoint presets（两套域名按你的账户区域选择）
# ==============================

# ---- Preset A: Global (常见) ----
OKX_REST_BASE_URL=https://www.okx.com
OKX_WS_PUBLIC_URL=wss://wspap.okx.com:8443/ws/v5/public?brokerId=9999
OKX_WS_PRIVATE_URL=wss://wspap.okx.com:8443/ws/v5/private?brokerId=9999
OKX_WS_BUSINESS_URL=wss://wspap.okx.com:8443/ws/v5/business?brokerId=9999

# ---- Preset B: EEA (如果你的账户文档/域名显示 eea.*) ----
#OKX_REST_BASE_URL=https://eea.okx.com
#OKX_WS_PUBLIC_URL=wss://wseeapap.okx.com:8443/ws/v5/public
#OKX_WS_PRIVATE_URL=wss://wseeapap.okx.com:8443/ws/v5/private
#OKX_WS_BUSINESS_URL=wss://wseeapap.okx.com:8443/ws/v5/business

# --- OKX API Key (Demo APIKey) ---
# 如果 EXECUTION_MODE=DRYRUN，这里可以为空
OKX_API_KEY=
OKX_SECRET_KEY=
OKX_PASSPHRASE=

# --- Backup (optional profile ops) ---
BACKUP_INTERVAL_MIN=1440
BACKUP_KEEP_DAYS=7
BACKUP_DIR=/backups
